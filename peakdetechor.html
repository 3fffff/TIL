<!DOCTYPE html>

<html>

<script>
    function createPeakDetector(lag, threshold, influence) {
        this.lag = lag
        this.threshold = threshold
        this.influence = influence
        this.init = false
        this.buffer = new Array(lag).fill(0); 
        this.prevAvg = 0
        this.prevVar = 0
        this.prevData = 0
        this.prevStddev = 0
        this.idx = 0

        return function (sample) {
            let peak = 0;

            const deviation = sample - this.prevAvg;
            if (deviation > this.threshold * this.prevStddev && this.init == 1) {
                sample = this.influence * sample + (1.0 - this.influence) * this.prevData;
                peak = 1;
            }
            else if (deviation < -1.0 * this.threshold * this.prevStddev && this.init == 1) {
                sample = this.influence * sample + (1.0 - this.influence) * this.prevData;
                peak = -1;
            }

            const oldval = this.buffer[this.idx];
            this.buffer[this.idx] = sample;
            this.idx++;
            if (this.idx == this.lag) {
                this.idx = 0;
                this.init = 1;
            }
            const newAvg = this.prevAvg + (sample - oldval) / this.lag;
            this.prevVar = this.prevVar + (sample - newAvg + oldval - this.prevAvg) * (sample - oldval) / (this.lag - 1);
            this.prevAvg = newAvg;
            this.prevData = sample;
            this.prevStddev = Math.sqrt(this.prevVar);
            return peak
        }
    }
    const y = [1, 1, 1.1, 1, 0.9, 1, 1, 1.1, 1, 0.9, 1, 1.1, 1, 1, 0.9, 1, 1, 1.1, 1, 1, 1, 1, 1.1, 0.9, 1, 1.1, 1, 1, 0.9, 1, 1.1, 1, 1, 1.1, 1, 0.8, 0.9, 1, 1.2, 0.9, 1, 1, 1.1, 1.2, 1, 1.5, 1, 3, 2, 5, 3, 2, 1, 1, 1, 0.9, 1, 1, 3, 2.6, 4, 3, 3.2, 2, 1, 1, 0.8, 4, 4, 2, 2.5, 1, 1, 1];

    const peakDetector = createPeakDetector(30, 5.0, 0.01)
    const peaks = []
    for (let i = 0; i < y.length; i++)
        peaks.push(peakDetector(y[i]))
    console.log(peaks)
</script>

</html>
