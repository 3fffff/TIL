<!DOCTYPE html>

<html>

<script>
    function createPeakDetector(lag, threshold, influence, influenceAvg, plus, minus) {
        this.lag = lag
        this.threshold = threshold
        this.influence = influence
        this.influenceAvg = influenceAvg
        this.init = false
        this.idx = 0
        this.plus = plus
        this.minus = minus

        return function (sample) {
            let peak = 0;
            let nextAvg = sample;

            const deviation = sample - this.prevAvg;
            if (Math.abs(deviation) > this.threshold * this.prevStddev && this.prevStddev != 0) {
                sample = this.influence * sample + (1.0 - this.influence) * this.prevData;
                nextAvg = this.influenceAvg * sample + (1.0 - this.influenceAvg) * this.prevData;
                if (deviation > 0 && this.plus == true)
                    peak = 1;
                else if (deviation < 0 && this.minus == true)
                    peak = -1;
            }

            if (this.idx == this.lag)
                this.idx = 0;
            this.idx++;
            if (this.idx == 1) {
                this.prevAvg = sample;
                this.prevVar = 0;
                this.prevData = sample;
            }
            else {
                const Avg = this.prevAvg + (nextAvg - this.prevData) / (this.idx - 1);
                const Var = this.prevVar + (nextAvg - Avg + this.prevData - this.prevAvg) * (sample - this.prevData) / (this.idx - 1);
                this.prevStddev = Math.sqrt(Var);
                this.prevAvg = Avg;
                this.prevVar = Var;
                this.prevData = sample;
            }
            return peak
        }
    }
    const y = [1, 1, 1.1, 1, 0.9, 1, 1, 1.1, 1, 0.9, 1, 1.1, 1, 1, 0.9, 1, 1, 1.1, 1, 1, 1, 1, 1.1, 0.9, 1, 1.1, 1, 1, 0.9, 1, 1.1, 1, 1, 1.1, 1, 0.8, 0.9, 1, 1.2, 0.9, 1, 1, 1.1, 1.2, 1, 1.5, 1, 3, 2, 5, 3, 2, 1, 1, 1, 0.9, 1, 1, 3, 2.6, 4, 3, 3.2, 2, 1, 1, 0.8, 4, 4, 2, 2.5, 1, 1, 1];

    const peakDetector = createPeakDetector(30, 5.0, 0.0, 0.0, true, false)
    const peaks = []
    for (let i = 0; i < y.length; i++)
        peaks.push(peakDetector(y[i]))
    console.log(peaks)
</script>

</html>
